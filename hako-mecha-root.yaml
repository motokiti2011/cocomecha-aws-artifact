AWSTemplateFormatVersion: "2010-09-09"
Description: Manage myself verification environment

Parameters:
  # LambdaCode格納先のS3Buketを記述
  S3Buket:
    Type: String
    Description: S3Buket
  # テンプレート格納先のURL
  TemplateUrl:
    Type: String
    Description: TemplateURL
  # Lambdaコード格納先のディレクトリ名
  LambdaCodeDirectory:
    Type: String
    Description: LambdaCodeDirectory


Resources:

  # Roleの作成
  Role:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'iam/cocomecha-role.yaml'


  # DynamoDBの作成
  DynamoDBRoot:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'tbl-root.yaml'
      Parameters:
        TemplateUrl: !Join 
        - ''
        - - !Ref TemplateUrl

  # Lambdaの作成
  BasicLambdaRoot:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'basic-lambda-root.yaml'
      Parameters:
        LambdaRoleArn: !GetAtt Role.Outputs.DynamoDBAccessRole
        S3Buket: !Ref S3Buket
        LambdaCodeDirectory: !Join 
        - ''
        - - !Ref LambdaCodeDirectory
        TemplateUrl: !Join 
        - ''
        - - !Ref TemplateUrl


  GsiLambdaRoot:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'gsi-lambda-root.yaml'
      Parameters:
        LambdaRoleArn: !GetAtt Role.Outputs.DynamoDBAccessRole
        S3Buket: !Ref S3Buket
        LambdaCodeDirectory: !Join 
        - ''
        - - !Ref LambdaCodeDirectory
        TemplateUrl: !Join 
        - ''
        - - !Ref TemplateUrl

  CheckLambdaRoot:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'check-lambda-root.yaml'
      Parameters:
        LambdaRoleArn: !GetAtt Role.Outputs.DynamoDBAccessRole
        S3Buket: !Ref S3Buket
        LambdaCodeDirectory: !Join 
        - ''
        - - !Ref LambdaCodeDirectory
        TemplateUrl: !Join 
        - ''
        - - !Ref TemplateUrl


  # Cognitoの作成
  Cognito:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'cognito/cocomecha-cognito.yaml'


  # APIGatewayの作成
  BasicApigateway:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'basic-apigateway.yaml'
      Parameters:
        BrowsingHistoryLambdaArn: !GetAtt BasicLambdaRoot.Outputs.BrowsingHistoryLambda
        CompletionSlipLambdaArn: !GetAtt BasicLambdaRoot.Outputs.CompletionSlipLambda
        EvaluationInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.EvaluationInfoLambda
        HistoryInfoMechaLambdaArn: !GetAtt BasicLambdaRoot.Outputs.HistoryInfoMechaLambda
        HistoryInfoOfficeLambdaArn: !GetAtt BasicLambdaRoot.Outputs.HistoryInfoOfficeLambda
        MechanicInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.MechanicInfoLambda
        OfficeInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.OfficeInfoLambda
        SlipDetailInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.SlipDetailInfoLambda
        SlipMegPrmUserLambdaArn: !GetAtt BasicLambdaRoot.Outputs.SlipMegPrmUserLambda
        SlipMessageInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.SlipMessageInfoLambda
        SlipQuestionLambdaArn: !GetAtt BasicLambdaRoot.Outputs.SlipQuestionLambda
        SlipVehicleLambdaArn: !GetAtt BasicLambdaRoot.Outputs.SlipVehicleLambda
        TransactionSlipLambdaArn: !GetAtt BasicLambdaRoot.Outputs.TransactionSlipLambda
        UserFavoriteLambdaArn: !GetAtt BasicLambdaRoot.Outputs.UserFavoriteLambda
        UserInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.UserInfoLambda
        UserMyListLambdaArn: !GetAtt BasicLambdaRoot.Outputs.UserMyListLambda
        UserVehicleInfoLambdaArn: !GetAtt BasicLambdaRoot.Outputs.UserVehicleInfoLambda
        GetSlipLambdaArn: !GetAtt BasicLambdaRoot.Outputs.GetSlipLambda
        MessageParmRequestLambdaArn: !GetAtt BasicLambdaRoot.Outputs.MessageParmRequestLambda
        InitPostSlipLambdaArn: !GetAtt BasicLambdaRoot.Outputs.InitPostSlipLambda
        InitMechanicUserLambdaArn: !GetAtt BasicLambdaRoot.Outputs.InitMechanicUserLambda
        UserPoolArn: !GetAtt Cognito.Outputs.UserPoolArn

  GsiApigateway:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'gsi-apigateway.yaml'
      Parameters:
        BrowsingHistoryGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.BrowsingHistoryGSILambda
        CompletionSlipGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.CompletionSlipGSILambda
        EvaluationInfoGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.EvaluationInfoGSILambda
        HistoryInfoMechaGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.HistoryInfoMechaGSILambda
        HistoryInfoOfficeGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.HistoryInfoOfficeGSILambda
        SlipDetailInfoGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.SlipDetailInfoGSILambda
        SlipQuestionGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.SlipQuestionGSILambda
        TransactionSlipGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.TransactionSlipGSILambda
        UserFavoriteGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.UserFavoriteGSILambda
        UserMyListGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.UserMyListGSILambda
        MechanicInfoGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.MechanicInfoGSILambda
        UserVehicleInfoGSILambdaArn: !GetAtt GsiLambdaRoot.Outputs.UserVehicleInfoGSILambda

        UserPoolArn: !GetAtt Cognito.Outputs.UserPoolArn


  CheckApigateway:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 'check-apigateway.yaml'
      Parameters:
        SlipMegPrmUserCheckLambdaArn: !GetAtt CheckLambdaRoot.Outputs.SlipMegPrmUserCheckLambda

        UserPoolArn: !GetAtt Cognito.Outputs.UserPoolArn


  # S3（画像アップロード用）の作成
  S3:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join 
        - ''
        - - !Ref TemplateUrl
          - 's3/cocomecha-s3-upload.yaml'
      Parameters:
        S3BucketName: 'cocomecha-s3-upload'


Outputs:
  # 構築したリージョン
  Region:
    Value: !Ref AWS::Region
    Description: Region
  # CognitoIDプールID
  CognitoIdentityPoolId:
    Value: !GetAtt Cognito.Outputs.IdentityPool
    Description: Cognito IdentityPoolId
  # CognitoユーザープールID
  CognitoUserPoolId:
    Value: !GetAtt Cognito.Outputs.UserPoolId
    Description: Cognito UserPoolId
  # CognitoアプリケーションクライアントID
  CognitoClientId:
    Value: !GetAtt Cognito.Outputs.UserPoolClient
    Description: Cognito ClientId
  # 画像アップロード用S3バケット名
  S3UploadBucketName:
    Value: !GetAtt S3.Outputs.S3BucketName
    Description: S3 Upload BucketName
